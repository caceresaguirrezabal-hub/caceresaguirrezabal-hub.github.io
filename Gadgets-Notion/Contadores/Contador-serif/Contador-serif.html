<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub Pages Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas,
          "Liberation Mono", monospace;
      }
      .icon-file::before {
        content: "[FILE] ";
        font-weight: bold;
        color: #60a5fa;
      }
      .icon-folder::before {
        content: "[DIR]  ";
        font-weight: bold;
        color: #93c5fd;
      }
      .icon-back::before {
        content: "[..]   ";
        font-weight: bold;
        color: #cbd5e1;
      }
      .copy-feedback {
        font-size: 0.75rem;
        color: #34d399;
        opacity: 0;
        transition: opacity 0.2s;
      }
    </style>
    <link
      id="dynamic-favicon"
      rel="icon"
      href="image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÅ</text></svg>"
    />
  </head>
  <body class="bg-gray-900 text-gray-200">
    <div class="max-w-4xl mx-auto px-4 py-6">
      <header class="mb-6">
        <h1 class="text-xl font-bold">GitHub Pages Explorer</h1>
        <p class="text-gray-400 mt-1">
          Serving from:
          <code class="bg-gray-800 px-2 py-1 rounded"
            >https://caceresaguirrezabal-hub.github.io</code
          >
        </p>
        <div class="mt-2">
          <strong>Path:</strong>
          <code id="current-path" class="ml-2 bg-gray-800 px-2 py-1 rounded"
            >/</code
          >
        </div>
      </header>

      <main>
        <div id="loading" class="hidden py-3 text-gray-400">
          Loading directory contents...
        </div>

        <div
          id="error"
          class="hidden bg-red-900/30 border-l-4 border-red-500 p-3 mb-4"
        >
          <strong>Error:</strong> <span id="error-message">Unknown error.</span>
        </div>

        <div id="empty" class="hidden py-4 text-gray-500">
          [Empty directory]
        </div>

        <div
          id="content"
          class="hidden bg-gray-800 rounded border border-gray-700 overflow-hidden"
        >
          <ul id="file-list" class="divide-y divide-gray-700"></ul>
        </div>
      </main>

      <footer class="mt-8 text-gray-500 text-xs">
        Copy GH Pages URLs to share live pages. Works in Notion embeds.
      </footer>
    </div>

    <script>
      // === FAVICON üìÅ ===
      (function () {
        try {
          var canvas = document.createElement("canvas");
          canvas.width = 32;
          canvas.height = 32;
          var ctx = canvas.getContext("2d");
          ctx.font = "28px sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillStyle = "#4b5563";
          ctx.fillText("üìÅ", 16, 16);
          var favicon = document.getElementById("dynamic-favicon");
          if (favicon) favicon.href = canvas.toDataURL("image/png");
        } catch (e) {}
      })();

      // === CONFIG ===
      var GH_PAGES_BASE = "https://caceresaguirrezabal-hub.github.io";
      var USER = "caceresaguirrezabal-hub";
      var REPO = "caceresaguirrezabal-hub.github.io";
      var API_URL =
        "https://api.github.com/repos/" + USER + "/" + REPO + "/contents";

      // DOM
      var elLoading = document.getElementById("loading");
      var elError = document.getElementById("error");
      var elErrorMessage = document.getElementById("error-message");
      var elEmpty = document.getElementById("empty");
      var elContent = document.getElementById("content");
      var elFileList = document.getElementById("file-list");
      var elCurrentPath = document.getElementById("current-path");

      // === STATE MANAGEMENT (using hash) ===
      function setHash(path) {
        // Normalize: remove leading/trailing slashes
        var clean = path.replace(/^\/+|\/+$/g, "");
        window.location.hash = clean ? clean : "";
      }

      function getHashPath() {
        var hash = window.location.hash.substring(1); // remove '#'
        return decodeURIComponent(hash);
      }

      // === UI HELPERS ===
      function show(el) {
        el.classList.remove("hidden");
      }
      function hide(el) {
        el.classList.add("hidden");
      }
      function setLoading() {
        hide(elError);
        hide(elEmpty);
        hide(elContent);
        show(elLoading);
      }
      function setError(msg) {
        hide(elLoading);
        hide(elEmpty);
        hide(elContent);
        elErrorMessage.textContent = msg;
        show(elError);
      }
      function setEmpty() {
        hide(elLoading);
        hide(elError);
        hide(elContent);
        show(elEmpty);
      }
      function setContent() {
        hide(elLoading);
        hide(elError);
        hide(elEmpty);
        show(elContent);
      }

      function formatSize(bytes) {
        if (!bytes) return "";
        var units = ["B", "KB", "MB", "GB"];
        var i = 0;
        while (bytes >= 1024 && i < units.length - 1) {
          bytes /= 1024;
          i++;
        }
        return Math.round(bytes * 10) / 10 + " " + units[i];
      }

      function copyToClipboard(text, button) {
        if (!navigator.clipboard) return alert("Clipboard not supported");
        navigator.clipboard.writeText(text).then(function () {
          var f = document.createElement("span");
          f.className = "copy-feedback ml-2";
          f.textContent = "‚úì Copied!";
          button.parentNode.appendChild(f);
          f.style.opacity = "1";
          setTimeout(() => {
            f.style.opacity = "0";
            setTimeout(() => f.remove(), 200);
          }, 1500);
        });
      }

      // === NAVIGATION ===
      function loadDirectory(path) {
        setLoading();
        elCurrentPath.textContent = path === "" ? "/" : "/" + path;

        var url = API_URL;
        if (path) url += "/" + encodeURIComponent(path);

        fetch(url)
          .then(function (res) {
            if (!res.ok)
              return res.json().then((err) => {
                throw new Error(err.message || "HTTP " + res.status);
              });
            return res.json();
          })
          .then(function (data) {
            if (!Array.isArray(data)) {
              if (data.download_url) window.open(data.download_url, "_blank");
              return;
            }

            if (data.length === 0) {
              setEmpty();
              return;
            }

            elFileList.innerHTML = "";

            if (path) {
              var parentPath = path.split("/").slice(0, -1).join("/");
              var li = document.createElement("li");
              li.className = "px-3 py-2 hover:bg-gray-700 cursor-pointer";
              li.innerHTML =
                '<div class="flex items-center justify-between"><span class="icon-back"></span><span>Parent directory</span><span></span></div>';
              li.onclick = () => navigateTo(parentPath);
              elFileList.appendChild(li);
            }

            var dirs = data.filter((i) => i.type === "dir");
            var files = data.filter((i) => i.type === "file");
            [...dirs, ...files].forEach((item) => {
              var li = document.createElement("li");
              li.className =
                "px-3 py-2 hover:bg-gray-700 cursor-pointer border-t border-gray-700 first:border-t-0";
              var isDir = item.type === "dir";
              var sizeText = isDir ? "" : " (" + formatSize(item.size) + ")";
              var iconClass = isDir ? "icon-folder" : "icon-file";
              var actions = "";
              if (!isDir && item.path) {
                var ghUrl = GH_PAGES_BASE + "/" + item.path;
                actions =
                  "<button onclick=\"window.open('" +
                  ghUrl +
                  "','_blank');event.stopPropagation();\" class=\"text-blue-400 hover:text-blue-300 text-xs mr-2\">[View]</button>" +
                  '<a href="' +
                  ghUrl +
                  '" download="' +
                  item.name +
                  '" class="text-green-400 hover:text-green-300 text-xs mr-2">[Download]</a>' +
                  "<button onclick=\"copyToClipboard('" +
                  ghUrl +
                  '\',this);event.stopPropagation();" class="text-yellow-400 hover:text-yellow-300 text-xs">[Copy GH Pages URL]</button>';
              }
              li.innerHTML =
                '<div class="flex items-center justify-between">' +
                '<div><span class="' +
                iconClass +
                '"></span><span>' +
                item.name +
                '</span><span class="text-gray-500 ml-2">' +
                sizeText +
                "</span></div>" +
                "<div>" +
                actions +
                "</div>" +
                "</div>";
              if (isDir)
                li.onclick = () =>
                  navigateTo(path ? path + "/" + item.name : item.name);
              elFileList.appendChild(li);
            });

            setContent();
          })
          .catch((err) => {
            console.error("Load failed:", err);
            setError("Failed: " + (err.message || "public repo required"));
          });
      }

      function navigateTo(path) {
        setHash(path); // ‚úÖ Guarda en URL
        loadDirectory(path);
      }

      // === INIT ===
      function init() {
        var initialPath = getHashPath();
        loadDirectory(initialPath);
      }

      // ‚úÖ Detect reloads & hash changes (critical for Notion)
      window.addEventListener("hashchange", function () {
        var newPath = getHashPath();
        loadDirectory(newPath);
      });

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
